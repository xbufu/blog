<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=content-language content="en">
<meta name=color-scheme content="light dark">
<meta http-equiv=content-security-policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net/; form-action 'self'; frame-src 'self'; img-src 'self'; object-src 'none'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/ https://cdn.jsdelivr.net/; script-src 'self' 'unsafe-inline' https://www.google-analytics.com; prefetch-src 'self'; connect-src 'self' https://www.google-analytics.com;">
<meta name=author content="Bufu">
<meta name=description content="Backing up TrueNAS datasets to Backblaze without storage limit">
<meta name=keywords content="blog,developer,personal,hacker,security">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="TrueNAS Backup to Backblaze">
<meta name=twitter:description content="Backing up TrueNAS datasets to Backblaze without storage limit">
<meta property="og:title" content="TrueNAS Backup to Backblaze">
<meta property="og:description" content="Backing up TrueNAS datasets to Backblaze without storage limit">
<meta property="og:type" content="article">
<meta property="og:url" content="https://bufu-sec.com/posts/truenas_backup_to_backblaze/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2023-01-26T18:37:40+01:00">
<meta property="article:modified_time" content="2023-01-26T18:37:40+01:00">
<title>
TrueNAS Backup to Backblaze · Bufu Blog
</title>
<link rel=canonical href=https://bufu-sec.com/posts/truenas_backup_to_backblaze/>
<link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin>
<link rel=stylesheet href=/css/coder.min.708686f8ab8176e91d44fcbe488a0fe0333b94f405cf18a52383d67ba22f0ccb.css integrity="sha256-cIaG+KuBdukdRPy+SIoP4DM7lPQFzxilI4PWe6IvDMs=" crossorigin=anonymous media=screen>
<link rel=stylesheet href=/css/coder-dark.min.aa883b9ce35a8ff4a2a5008619005175e842bb18a8a9f9cc2bbcf44dab2d91fa.css integrity="sha256-qog7nONaj/SipQCGGQBRdehCuxioqfnMK7z0Tastkfo=" crossorigin=anonymous media=screen>
<link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16>
<link rel=apple-touch-icon href=/images/apple-touch-icon.png>
<link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png>
<meta name=generator content="Hugo 0.87.0">
</head>
<body class="preload-transitions colorscheme-dark">
<div class=float-container>
<a id=dark-mode-toggle class=colorscheme-toggle>
<i class="fa fa-adjust fa-fw" aria-hidden=true></i>
</a>
</div>
<main class=wrapper>
<nav class=navigation>
<section class=container>
<a class=navigation-title href=/>
Bufu Blog
</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle>
<i class="fa fa-bars fa-fw" aria-hidden=true></i>
</label>
<ul class=navigation-list>
<li class=navigation-item>
<a class=navigation-link href=/about/>About</a>
</li>
<li class=navigation-item>
<a class=navigation-link href=/posts/>Blog</a>
</li>
<li class=navigation-item>
<a class=navigation-link href=/tags/>Tags</a>
</li>
<li class=navigation-item>
<a class=navigation-link href=/projects/>Projects</a>
</li>
<li class=navigation-item>
<a class=navigation-link href=https://wiki.bufu-sec.com>Wiki</a>
</li>
<li class=navigation-item>
<a class=navigation-link href=/contact/>Contact</a>
</li>
</ul>
</section>
</nav>
<div class=content>
<section class="container post">
<article>
<header>
<div class=post-title>
<h1 class=title>
<a class=title-link href=https://bufu-sec.com/posts/truenas_backup_to_backblaze/>
TrueNAS Backup to Backblaze
</a>
</h1>
</div>
<div class=post-meta>
<div class=date>
<span class=posted-on>
<i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2023-01-26T18:37:40+01:00>
January 26, 2023
</time>
</span>
<span class=reading-time>
<i class="fa fa-clock-o" aria-hidden=true></i>
4-minute read
</span>
</div>
<div class=tags>
<i class="fa fa-tag" aria-hidden=true></i>
<span class=tag>
<a href=/tags/truenas/>truenas</a>
</span>
<span class=separator>•</span>
<span class=tag>
<a href=/tags/backblaze/>backblaze</a>
</span>
<span class=separator>•</span>
<span class=tag>
<a href=/tags/backup/>backup</a>
</span></div>
</div>
</header>
<div>
<h1 id=backing-up-truenas-datasets-with-backblaze>
Backing up TrueNAS datasets with Backblaze
<a class=heading-link href=#backing-up-truenas-datasets-with-backblaze>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h1>
<p>Are you tired of being limited by storage restrictions when backing up your TrueNAS datasets? One solution is to use Backblaze, a popular cloud storage provider. However, by using a personal version of Backblaze in combination with virtual drives, you can bypass these limitations and create unlimited backups of your important data. In this blog post, we will walk you through the process of setting up this backup solution, including creating a backup user in TrueNAS, setting permissions on the dataset, creating an SMB share, and mounting the share with Dokany. We will also show you how to create a scheduled task for automatic remounting and how to add the virtual drive to your Backblaze account. By following these steps, you can ensure that your data is safe and secure, even with large amounts of storage space needed.</p>
<h2 id=1-create-backup-user-in-truenas>
1. Create backup user in TrueNAS
<a class=heading-link href=#1-create-backup-user-in-truenas>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p>Create a new user in TrueNAS to use for backups. We can&rsquo;t use the root user account, since it is not allowed to authenticate to SMB shares.</p>
<h2 id=2-set-acl-on-dataset-to-back-up>
2. Set ACL on dataset to back up
<a class=heading-link href=#2-set-acl-on-dataset-to-back-up>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p>We need to give our new backup user permission to access the dataset we want to back up.</p>
<ol>
<li>Select 3 dots on dataset and click <code>View Permissions</code></li>
<li>Click <code>Edit permissions</code> in the top right corner of the new pane</li>
<li>Click <code>Set ACL</code> to open the ACL editor</li>
<li>Select the <code>POSIX_RESTRICTED</code> default ACL</li>
<li>Add a new item of type <code>mask</code> with read, write and execute permissions. The mask defines the maximum permissions users other than the owner of the dataset can have.</li>
<li>Add another item for the backup user. Set the type to <code>User</code> and enter the username. Set permissions to read, write and execute.</li>
</ol>
<h2 id=3-create-the-smb-share>
3. Create the SMB share
<a class=heading-link href=#3-create-the-smb-share>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p>Go into shares in TrueNAS and create a new SMB share. Point it to the dataset you want to backup and give it a name.</p>
<h2 id=4-mount-the-smb-share-with-dokany>
4. Mount the SMB share with Dokany
<a class=heading-link href=#4-mount-the-smb-share-with-dokany>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p>We will mount the SMB share as a drive using the <code>mirror</code> utility from <code>Dokany</code>. This way Backblaze will think it is an actual hard drive and we will be able to back it up without storage limitations!</p>
<ol>
<li>Download the latest release of dokany from <a href=https://github.com/dokan-dev/dokany/releases>Github</a></li>
<li>Install it while selecting all components</li>
<li>Open PowerShell as Administrator and go into the directory where <code>mirror.exe</code> is located. For me it was in <code>C:\Program Files\Dokan\DokanLibrary-2.0.6\sample\mirror\</code></li>
<li>Test mount the SMB share as the <code>Z</code> drive using the following command: <code>.\mirror.exe /r \\192.168.0.9\share /l z</code></li>
<li>Verify the share was mounted with <code>ls Z:</code> or by browsing to it via the explorer</li>
</ol>
<h2 id=5-create-scheduled-task-to-mount-share-on-boot>
5. Create scheduled task to mount share on boot
<a class=heading-link href=#5-create-scheduled-task-to-mount-share-on-boot>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p>Since we don&rsquo;t want to have to manually remount the share each time the computer restarts, we will create a scheduled task to do it automatically.</p>
<ol>
<li>Press the Windows key and type <code>Task Scheduler</code></li>
<li>Click on <code>Task Scheduler Library</code></li>
<li>On the right, select <code>Create Task...</code></li>
<li>In the <code>General</code> tab, select</li>
<li>a name</li>
<li>Set <code>Run wether user is logged on or not</code></li>
<li>Set <code>Run with highest privileges</code></li>
<li>In <code>Triggers</code> tab, create a new trigger and select <code>At startup</code></li>
<li>In the <code>Actions</code> tab, create a new action</li>
<li>Set the action to <code>Start a program</code></li>
<li>Set the program to the path of the <code>mirror.exe</code> binary, i.e. <code>C:\Program Files\Dokan\DokanLibrary-2.0.6\sample\mirror\mirror.exe</code></li>
<li>Set the arguments to <code>/r \\192.168.0.9\share /l z</code></li>
<li>In the <code>Conditions</code> tab</li>
<li>Make sure both <code>Start the task only if computer is idle</code> and <code>Stop if computer ceases to be idle</code> are <strong>NOT</strong> selected</li>
<li>Deselected both options in the <code>Power</code> category as well</li>
<li>In the <code>Settings</code> tab</li>
<li>Select <code>Run task as soon as possible after a scheduled start is missed</code></li>
<li>Set <code>If the task fails, restart</code> and set it to restart every minute for 60 times</li>
<li>Deselect <code>Stop the task if it runs longer than</code></li>
</ol>
<h2 id=6-add-new-drive-to-backblaze>
6. Add new drive to Backblaze
<a class=heading-link href=#6-add-new-drive-to-backblaze>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p>We are basically finished now. Just restart the computer and the new drive should show up as expected. Now you simply need to add it in the settings in the Backblaze Control Panel.</p>
<p>In case Backblaze gives you an error about not being able to create a the <code>.bzvol</code> folder on the drive, check your share permissions. If your permissions on the share are fine, check if the folder has been created already. If it has, just run <code>chmod 777 .bzvol</code> on it and it should work.</p>
</div>
<footer>
</footer>
</article>
</section>
</div>
<footer class=footer>
<section class=container>
<p>Infosec Notes.</p>
©
2021 -
2023
Bufu
</section>
</footer>
</main>
<script src=/js/coder.min.03b17769f4f91ae35667e1f2a1ca8c16f50562576cf90ff32b3179926914daa5.js integrity="sha256-A7F3afT5GuNWZ+HyocqMFvUFYlds+Q/zKzF5kmkU2qU="></script>
</body>
</html>